---
layout: post
title: Page Rank
comments: true
---


To install [Systematic Investor Toolbox (SIT)](https://github.com/systematicinvestor/SIT) please visit [About](/about) page.




Let's continue with [Run Leadership Rcpp](/Run-Leadership-Rcpp) post and look at
results and PageRank

First, let's load historical prices for S&P 500:


{% highlight r %}
#*****************************************************************
# Load historical end of day data
#*****************************************************************
library(SIT)
load.packages('quantmod')

filename = 'big.test.Rdata'

if(!file.exists(filename)) {
  tickers = nasdaq.100.components()
  tickers = sp500.components()$tickers

  data = env()
  getSymbols.extra(tickers, src = 'yahoo', from = '1970-01-01', env = data, auto.assign = T)
  
	rm.index = which(sapply(ls(data), function(i) is.null(data[[i]])))
	if(any(rm.index)) env.del(names(rm.index), data)
  
  for(i in ls(data)) data[[i]] = adjustOHLC(data[[i]], use.Adjusted=T)
  #print(bt.start.dates(data))

  bt.prep(data, align='keep.all', dates='2000::', fill.gaps=T)

  # remove ones with little history
  prices = data$prices
  bt.prep.remove.symbols(data, which(
   	count(prices, side = 2) < 3*252 | is.na(last(prices)) 
  ))
       
  # show the ones removed
  print(setdiff(tickers,names(data$prices)))

  prices = data$prices
  save(prices, file=filename)
}

load(file=filename)

#*****************************************************************
# Run Lead Lag Correlation
#*****************************************************************
prices = prices[,]

n = ncol(prices)
nperiod = nrow(prices)
ret = prices / mlag(prices) - 1

index =  (nperiod-20):nperiod
ret = ret[index,]
nperiod = nrow(ret)
nwindow = 15

#*****************************************************************
# Run Lead Lag Correlation
#*****************************************************************
# make sure to install [Rtools on windows](http://cran.r-project.org/bin/windows/Rtools/)
load.packages('Rcpp')
load.packages('RcppParallel')

# load Rcpp functions
sourceCpp('lead.lag.correlation.cpp')

c.cor = cp_run_leadership_smart(ret, nwindow, T)


clean.adj = function(adj.mat, threshold = 0.5) {
	adj.mat[ abs(adj.mat) < threshold] = 0
	keep.index = (rowSums(adj.mat != 0) > 1) | (colSums(adj.mat != 0) > 1)	
	adj.mat = adj.mat[keep.index, keep.index]	
	adj.mat
}

load.packages('igraph') 
adj.mat = c.cor[,,21]
	adj.mat = ifna(adj.mat, 0)
	rownames(adj.mat) = colnames(adj.mat) = colnames(prices)
	adj.mat = clean.adj(adj.mat, 0.4)

g  = graph.adjacency(adj.mat,weighted=TRUE)
df = get.data.frame(g)
print(head(df))
{% endhighlight %}



|rownames(x) |from |to  |    weight|
|:-----------|:----|:---|---------:|
|1           |KR   |K   | 0.4430628|
|2           |KR   |KSS | 0.4226061|
|3           |PVH  |K   | 0.4376208|
|4           |PVH  |KSS | 0.4371244|
|5           |PVH  |VFC | 0.4567495|
|6           |SHW  |VFC | 0.4421777|
    




{% highlight r %}
print(get.data.frame(g, what="vertices"))
{% endhighlight %}



|rownames(x) |name |
|:-----------|:----|
|K           |K    |
|KR          |KR   |
|KSS         |KSS  |
|PVH         |PVH  |
|SHW         |SHW  |
|VFC         |VFC  |
    




{% highlight r %}
print(get.data.frame(g, what="edges"))
{% endhighlight %}



|rownames(x) |from |to  |    weight|
|:-----------|:----|:---|---------:|
|1           |KR   |K   | 0.4430628|
|2           |KR   |KSS | 0.4226061|
|3           |PVH  |K   | 0.4376208|
|4           |PVH  |KSS | 0.4371244|
|5           |PVH  |VFC | 0.4567495|
|6           |SHW  |VFC | 0.4421777|
    




{% highlight r %}
#E(g)$weight

plot(g, edge.label=round(E(g)$weight, 3))
{% endhighlight %}

![plot of chunk plot-2](/public/images/2015-04-21-Page-Rank/plot-2-1.png) 

{% highlight r %}
print(to.nice(t(sort(page.rank(g, directed = TRUE)$vector))))
{% endhighlight %}



|KR   |PVH  |SHW  |KSS  |K    |VFC  |
|:----|:----|:----|:----|:----|:----|
|0.12 |0.12 |0.12 |0.20 |0.20 |0.25 |
    



*(this report was produced on: 2015-04-23)*
